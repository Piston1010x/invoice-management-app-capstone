<!-- templates/admin/invoice-list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .badge-DRAFT   { background:#6c757d }
    .badge-SENT    { background:#0d6efd }
    .badge-PAID    { background:#198754 }
    .badge-OVERDUE { background:#dc3545 }
    #table-wrapper { max-height:65vh; overflow-y:auto }
  </style>
</head>
<body class="p-4">

<!-- ───────── Navbar ───────── -->
<div th:replace="fragments/navbar :: body"></div>

<h1 class="mb-3">Invoices</h1>

<!-- ─────── Toast for success message ─────── -->
<div aria-live="polite" aria-atomic="true"
     class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div class="toast text-bg-success align-items-center border-0"
       id="successToast"
       role="alert"
       th:if="${success}" th:classappend="' show'">
    <div class="d-flex">
      <div class="toast-body" th:text="${success}">Action done!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- ========= Filter pills ========= -->
<div class="btn-group mb-3">
  <a th:href="@{/admin/invoices}" class="btn btn-sm"
     th:classappend="${filter==null} ? 'btn-primary' : 'btn-outline-primary'">All</a>
  <a th:each="st : ${T(com.invoiceapp.entity.InvoiceStatus).values()}"
     th:href="@{/admin/invoices(status=${st.name()})}"
     th:text="${st.name()}" class="btn btn-sm"
     th:classappend="${filter?.name()==st.name()} ? 'btn-primary' : 'btn-outline-primary'"></a>
</div>

<!-- ========= Table ========= -->
<div id="table-wrapper" class="table-responsive">

  <table class="table table-hover align-middle">
    <thead class="table-light">
    <tr>
      <th>#</th><th>Client</th>
      <th class="text-end">Total</th>
      <th>Status</th><th>Issued</th><th>Due</th>
      <th class="text-end">Actions</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="inv : ${invoices}">
      <td th:text="${inv.invoiceNumber}">INV-00001</td>
      <td th:text="${inv.clientName}">Acme Ltd</td>
      <td class="text-end" th:text="${inv.total}">100.00</td>

      <td><span class="badge" th:classappend="'badge-'+${inv.status}"
                th:text="${inv.status}">DRAFT</span></td>

      <td th:text="${inv.issueDate} ?: '-'">-</td>
      <td th:text="${inv.dueDate}">-</td>

      <td class="text-end">
        <!-- Send -->
        <form th:if="${inv.status.name() == 'DRAFT'}"
              th:action="@{|/admin/invoices/${inv.id}/send|}" method="post" style="display:inline">
          <button class="btn btn-sm btn-primary">Send</button>
        </form>

        <!-- Mark-paid -->
        <form th:if="${inv.status.name()=='SENT' || inv.status.name()=='OVERDUE'}"
              th:action="@{|/admin/invoices/${inv.id}/mark-paid|}" method="post" style="display:inline">
          <button class="btn btn-sm btn-success">Paid</button>
        </form>

        <!-- PDF -->
        <a th:href="@{|/admin/invoices/${inv.id}/pdf|}" target="_blank"
           class="btn btn-sm btn-outline-secondary" title="Download PDF">PDF</a>

        <!-- Delete (disabled for PAID) -->
        <form th:action="@{|/admin/invoices/${inv.id}/delete|}" method="post" style="display:inline"
              onsubmit="return confirm('Delete this invoice permanently?');">
          <button class="btn btn-sm btn-outline-danger"
                  th:disabled="${inv.status.name() == 'PAID'}"
                  th:title="${inv.status.name() == 'PAID'} ? 'Paid invoices are protected' : 'Delete invoice'">
            Delete
          </button>
        </form>
      </td>
    </tr>
    </tbody>
  </table>

  <!-- ════════ Pagination (NEW) ════════ -->
  <nav aria-label="Page nav">
    <ul class="pagination justify-content-center">

      <!-- « Previous -->
      <li class="page-item" th:classappend="${page.first}? 'disabled'">
        <a class="page-link"
           th:href="@{/admin/invoices(page=${page.number-1},status=${filter?.name()})}">&laquo;</a>
      </li>

      <!-- numbered links -->
      <li class="page-item"
          th:each="i : ${#numbers.sequence(0,page.totalPages-1)}"
          th:classappend="${i==page.number}? 'active'">
        <a class="page-link"
           th:href="@{/admin/invoices(page=${i},status=${filter?.name()})}"
           th:text="${i+1}">1</a>
      </li>

      <!-- Next » -->
      <li class="page-item" th:classappend="${page.last}? 'disabled'">
        <a class="page-link"
           th:href="@{/admin/invoices(page=${page.number+1},status=${filter?.name()})}">&raquo;</a>
      </li>
    </ul>
  </nav>
  <!-- ──────────────────────────────── -->

</div><!-- /#table-wrapper -->

<!-- Floating + button -->
<a href="/admin/invoices/new"
   class="btn btn-primary rounded-circle"
   style="position:fixed;bottom:2rem;right:2rem;width:60px;height:60px;
          display:flex;align-items:center;justify-content:center;font-size:1.5rem;">+</a>

<!-- Bootstrap JS for toast -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (() => {
    const toastEl = document.getElementById('successToast');
    if (toastEl) {
      bootstrap.Toast.getOrCreateInstance(toastEl, {delay: 3000}).show();
    }
  })();
</script>
</body>
</html>
